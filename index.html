<!DOCTYPE html>
<html>
    <head>
        <title>Task Manager</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="style.css"/>        
        <link rel ="stylesheet" href="jquery-ui-1.11.4.custom/jquery-ui.css">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="https://raw.githubusercontent.com/noizwaves/bootstrap-social-buttons/v1.0.0/social-buttons.css">	

        <link rel="stylesheet" href="bootstrap-social.css">		

        <script src="jquery-2.2.1.js"></script>
        <script src="jquery-ui-1.11.4.custom/jquery-ui.js"></script>
        <script src="jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>

        


        <link rel="stylesheet" href="style.css"/>	

        <script type="text/javascript">
		
                    var CLIENT_ID = '165219503046-uec4qg1cqbaok7fq754t4bcqbl90hj82.apps.googleusercontent.com';
                    var SCOPES = 'https://www.googleapis.com/auth/drive';
					
					var metadata = {}; // file metadata for creating/updating
					var appData = {}; // data for saving
					var contentType = 'application/json';
					var fileDefault = {}; // default source file with data	
					
                    /**
                     * Called when the client library is loaded to start the auth flow.
                     */
					 
                            function handleClientLoad() {
                            window.setTimeout(checkAuth, 1);
                                    }
                    /**
                     * Check if the current user has authorized the application.
                     */
                    function checkAuth() {
                    gapi.auth.authorize(
                    {'client_id': CLIENT_ID, 'scope': SCOPES, 'immediate': true},
                            handleAuthResult);
                            }
                    /**
                     * Called when authorization server replies.
                     *
                     * @param {Object} authResult Authorization result.
                     */
                    function handleAuthResult(authResult) {
							var authButton = document.getElementById('authorizeButton');
                            var doitButton = document.getElementById('doitButton');
                            authButton.style.display = 'none';
                            doitButton.style.display = 'none';
                            if (authResult && !authResult.error) {
							// Access token has been successfully retrieved, requests can be sent to the API.
							 gapi.client.load('drive', 'v2', function(){
								getFile();
								alert("1");
								doitButton.style.display = 'block';
							  });
							} else {
							  authButton.style.display = 'block';
							}
						  }				  
						  
						  
						  function saveData() {
							metadata = getFileMetadata();
							//console.log(metadata);
							checkFileExists(metadata.title, saveDataHandle);
						  }
						  
						  function saveDataHandle(fileExists) {
							if(fileExists){
							  console.log('File already exists...');
							  updateFile(fileExists);
							} else {
							  console.log('Will create a new file...');
							  createFile();
							}
						  }
						  
						  
						   function getFileMetadata() {
							return {
							  'title': 'tasks' ,////////////////////
							  'mimeType': contentType
							}
						  }
						  
						    function createFile() {
								console.log('Creating a new file ('+metadata.title+') with data:');
								appData = document.getElementById('json').value;
								console.log(appData);
								const boundary = '-------314159265358979323846264';
								const delimiter = "\r\n--" + boundary + "\r\n";
								const close_delim = "\r\n--" + boundary + "--";
								var base64Data = btoa(appData);
								var multipartRequestBody =
									delimiter +
									'Content-Type: application/json\r\n\r\n' +
									JSON.stringify(metadata) +
									delimiter +
									'Content-Type: ' + contentType + '\r\n' +
									'Content-Transfer-Encoding: base64\r\n' +
									'\r\n' +
									base64Data +
									close_delim;
								var request = gapi.client.request({
									'path': '/upload/drive/v2/files',
									'method': 'POST',
									'params': {'uploadType': 'multipart'},
									'headers': {
									  'Content-Type': 'multipart/mixed; boundary="' + boundary + '"'
									},
									'body': multipartRequestBody});
								request.execute(function(res) {
								  console.log('New file created! Fileinfo:');
								  console.log(res);
								  fileDefault.id = res.id;
								  fileDefault.title = res.title;
								  setData();
								});
							  }
							  
							  function updateFile(fileId) {
								if(!fileId){ return; }
								console.log('Updating file ('+metadata.title+') with data:');
								console.log(document.getElementById('json').value);
								const boundary = '-------314159265358979323846';
								const delimiter = "\r\n--" + boundary + "\r\n";
								const close_delim = "\r\n--" + boundary + "--";
								var base64Data = btoa(document.getElementById('json').value);
								var multipartRequestBody =
									delimiter +
									'Content-Type: application/json\r\n\r\n' +
									JSON.stringify(metadata) +
									delimiter +
									'Content-Type: ' + contentType + '\r\n' +
									'Content-Transfer-Encoding: base64\r\n' +
									'\r\n' +
									base64Data +
									close_delim;
								var request = gapi.client.request({
									'path': '/upload/drive/v2/files/' + fileId,
									'method': 'PUT',
									'params': {'uploadType': 'multipart', 'alt': 'json'},
									'headers': {
									  'Content-Type': 'multipart/mixed; boundary="' + boundary + '"'
									},
									'body': multipartRequestBody});
								request.execute(function(res){
								  console.log('File successfully updated!');
								});
							  }
						  
						  
					
					
					 function getData(){						
						
						if (elemDef){
						  fileDefault = elemDef;						  
						}
					  }
					  
					  function setData(){
						if(fileDefault.id){
						  document.getElementById('json').value = fileDefault;
						  
						} /*else {
						  localStorage.removeItem(stName);
						}*/
					  }
					  
					   function findFile(fname){
					  
						var req = gapi.client.drive.files.list({q: "title='tasks'"});
						
						var id = req.execute(function(r){
						console.log('We are loading data...');
							var request = gapi.client.drive.files.get({
							  'fileId': r.items[0].id
							});		
							request.execute(function(resp) {
							  downloadFile(resp);							  
							});							
						});			
						
					  }					  
					  
					   function getFile() {
							//if(!fileDefault.id){ return false; }
							metadata = getFileMetadata();
							//console.log(metadata);
							findFile(metadata.title);
						  }
					  
					  
					  function downloadFile(file) {
						if (file.downloadUrl) {
						  var accessToken = gapi.auth.getToken().access_token;
						  var xhr = new XMLHttpRequest();
						  xhr.open('GET', file.downloadUrl);
						  xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
						  xhr.onload = function() {
							console.log('Data downloaded:')
							//appData = JSON.parse(xhr.responseText);
							appData = xhr.responseText;
							document.getElementById('json').value = appData;
							console.log(appData);
						  };
						  xhr.onerror = function() {
							console.log('XHR error!');
						  };
						  xhr.send();
						} else {
						  console.log('Can\'t download...');
						}
					  }
					  
					  
					  
					  function checkFileExists(fname, callback){
					  
						var req = gapi.client.drive.files.list({q: "title='tasks'"});
						req.execute(function(r){
						  console.log(r);
						  var len = r.items ? r.items.length : 0;
						  if(r.items && r.items.length && r.items[0].id){
							callback(r.items[0].id);
						  } else {
							callback();
						  }
						});
					  }
					


        </script>

		

        <script type="text/javascript" src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
		

    </head>

    <body>	
        <input type="text" id="json" >
		
		

        <input type="button" id="doitButton"   onclick="saveData()"   style="display: none" value="Save Data"/> <br>
		<input type="button" id="getFile" onclick="getFile()" style="display: show" value="Get data from file" />
        <input type="button" id="authorizeButton" style="display: show" value="Authorize" />

        <div id="div_tasks">

            <div id="inputContainer">
                <input id="taskInput" class="new-todo form-control" name = "new" placeholder="Add new task"  maxlength="25" autofocus>
                <a id="plus"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></a>
            </div>
            <div id="listWrapper">
                <ul id="taskList"></ul>
            </div>

        </div>


<script src="taskManager.js"></script>	

    </body>
</html>
